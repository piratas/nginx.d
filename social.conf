server {
	listen 80;
	listen [::]:80;

	## FIXME: change domain name here (and also make sure you do the same in the next 'server' section)
	server_name	social.pirata.xyz;

	## redirect all traffic to HTTPS
	return		301	http://ro4a6wyb4bjqpqgg.onion$request_uri;
}

server {
	listen 80;
	listen [::]:80;

	## FIXME: change domain name here (and also make sure you do the same in the next 'server' section)
	server_name	social.partidopirata.xyz;

	## redirect all traffic to HTTPS
	return		301	http://ro4a6wyb4bjqpqgg.onion$request_uri;
}
server {
	listen 80;
	listen [::]:80;

	## FIXME: change domain name here (and also make sure you do the same in the next 'server' section)
	server_name	social.piratas.xyz;

	## redirect all traffic to HTTPS
	return		301	http://ro4a6wyb4bjqpqgg.onion$request_uri;
}

server {
	listen	80;
	listen	[::]:80;
	server_name	*.social.pirata.xyz;
	return		301	http://ro4a6wyb4bjqpqgg.onion$request_uri;
}
server {
	listen	80;
	listen	[::]:80;
	server_name	*.social.partidopirata.xyz;
	return		301	http://ro4a6wyb4bjqpqgg.onion$request_uri;
}
server {
	listen	80;
	listen	[::]:80;
	server_name	*.social.piratas.xyz;
	return		301	http://ro4a6wyb4bjqpqgg.onion$request_uri;
}

server {
	## Use HTTPS. Seriously. Set it up with a cert (any cert) before you run the install.
	listen 443 ssl;
	listen [::]:443 ssl;

	## Server name
	## Change "social.example.org" to your site's domain name
	server_name	social.pirata.xyz;

	## SSL
	## Uncomment and change the paths to setup
	## your SSL key/cert. See https://cipherli.st/
	## for more information
	ssl_certificate		/etc/letsencrypt/live/pirata.xyz/fullchain.pem;
	ssl_certificate_key	/etc/letsencrypt/live/pirata.xyz/privkey.pem;
	ssl_trusted_certificate	/etc/letsencrypt/live/pirata.xyz/chain.pem;
	ssl_protocols			TLSv1 TLSv1.1 TLSv1.2;
	ssl_prefer_server_ciphers	on;
	ssl_ciphers			"EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
	ssl_ecdh_curve			secp384r1;
	ssl_session_cache		shared:SSL:10m;
	ssl_session_tickets		off;
	ssl_stapling			on;
	ssl_stapling_verify		on;
	#resolver			208.67.220.220 208.67.222.222 valid=300s;
	#resolver_timeout		5s;
	add_header			Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";
	add_header			X-Frame-Options SAMEORIGIN;
	add_header			X-Content-Type-Options nosniff;

	return		301	http://ro4a6wyb4bjqpqgg.onion$request_uri;

	## Logs
	## Uncomment and change the paths to setup
	## logging
	#access_log	/path/to/access.log;
	#error_log	/path/to/error.log;

	## Root
	## Change the path below to where you installed
	## GNU social
	#root	/var/www/git/social.pirata.xyz;

	## Index
	#index	index.php;

	## PHP
	#location ~ \.php {
		#include	snippets/fastcgi-php.conf;

		## This should be the same value as in your (optional) /etc/php5/fpm/pool.d/$server.conf
		#fastcgi_pass unix:/var/run/php5-fpm-social.sock;

		## Remove the "fastcgi_pass" line above and uncomment
		## the one below to use TCP sockets instead of Unix sockets
		#fastcgi_pass 127.0.0.1:9000;
	#}

	## Location
	#location / {
		#try_files	$uri $uri/ @gnusocial;
	#}

	## Fancy URLs
	#location @gnusocial {
		#rewrite ^(.*)$ /index.php?p=$1 last;
	#}

	## Restrict access that is unnecessary anyway
	#location ~ /\.(ht|git) {
		#deny all;
	#}
}

server {
	listen 443 ssl;
	listen [::]:443 ssl;

	server_name	social.piratas.xyz;

	ssl_certificate		/etc/letsencrypt/live/piratas.xyz/fullchain.pem;
	ssl_certificate_key	/etc/letsencrypt/live/piratas.xyz/privkey.pem;
	ssl_trusted_certificate	/etc/letsencrypt/live/piratas.xyz/chain.pem;
	ssl_protocols			TLSv1 TLSv1.1 TLSv1.2;
	ssl_prefer_server_ciphers	on;
	ssl_ciphers			"EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
	ssl_ecdh_curve			secp384r1;
	ssl_session_cache		shared:SSL:10m;
	ssl_session_tickets		off;
	ssl_stapling			on;
	ssl_stapling_verify		on;
	resolver			208.67.220.220 208.67.222.222 valid=300s;
	resolver_timeout		5s;
	add_header			Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";
	add_header			X-Frame-Options SAMEORIGIN;
	add_header			X-Content-Type-Options nosniff;

	return		301	http://ro4a6wyb4bjqpqgg.onion$request_uri;
}

## Tor
server {
	listen 127.0.0.1:42086;
	listen [::]:42086;

	server_name	ro4a6wyb4bjqpqgg.onion;

	root	/var/www/git/social.pirata.xyz;

	index	index.php;

	location ~* \.php$ {
		#include	snippets/fastcgi-php.conf;
		try_files $uri $uri/ /index.php;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		fastcgi_pass unix:/var/run/php5-fpm-social.sock;
		include fastcgi_params;
		fastcgi_index index.php;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_read_timeout 300;
	}

	#add_header X-Frame-Options DENY;
	add_header X-Content-Type-Options nosniff;

	## Location
	location / {
		try_files	$uri $uri/ @gnusocial;
	}

	## Fancy URLs
	location @gnusocial {
		rewrite ^(.*)$ /index.php?p=$1 last;
		break;
	}

	## Restrict access that is unnecessary anyway
	location ~ /\.(ht|git) {
		deny all;
	}

	location ~* ^/(.*)\.(ico|css|js|gif|png|jpg|bmp|JPG|jpeg)$ {
		root /var/www/git/social.pirata.xyz;
		rewrite ^/(.*)$ /$1 break;
		access_log off;
		expires max;
	}

}

